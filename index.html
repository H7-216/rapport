<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Générateur de Rapports Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Base & Reset */
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* A4 Paper Effect */
        .a4-page {
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.15);
            position: relative;
            transform-origin: top center;
        }

        /* Utilities */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Mobile Tabs Animation */
        .tab-active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
        .tab-inactive {
            color: #64748b;
            border-bottom-color: transparent;
        }

        /* Transitions */
        .fade-in {
            animation: fadeIn 0.2s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Print Overrides */
        @media print {
            body * { visibility: hidden; }
            #report-preview-container, #report-preview-container * { visibility: visible; }
            #report-preview-container {
                position: absolute;
                left: 0; top: 0;
                width: 100%; margin: 0; padding: 0;
                transform: none !important;
                box-shadow: none;
            }
            @page { size: A4; margin: 0; }
        }
    </style>
</head>
<body class="h-[100dvh] flex flex-col md:flex-row bg-slate-50 text-slate-800 overflow-hidden">

    <!-- === MOBILE HEADER === -->
    <header class="md:hidden h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 z-30 flex-shrink-0">
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar()" class="p-2 -ml-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            <span class="font-serif font-bold text-xl text-brand-900 tracking-tight">Rapport Pro</span>
        </div>
        <div class="flex gap-2">
             <!-- Mobile Actions (Save icon only) -->
             <button onclick="saveReportToHistory()" class="p-2 text-brand-600 bg-brand-50 rounded-full">
                <i data-lucide="save" class="w-5 h-5"></i>
             </button>
        </div>
    </header>

    <!-- === SIDEBAR (Navigation) === -->
    <!-- Overlay -->
    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-slate-900/50 z-40 hidden transition-opacity backdrop-blur-sm"></div>
    
    <!-- Drawer -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-slate-900 text-white z-50 transform -translate-x-full transition-transform duration-300 ease-out md:relative md:translate-x-0 md:w-64 shadow-2xl flex flex-col h-full invisible md:visible" ontransitionend="handleTransitionEnd(this)">
        
        <!-- Sidebar Header -->
        <div class="p-6 border-b border-slate-800 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center">
                    <i data-lucide="file-text" class="text-white w-5 h-5"></i>
                </div>
                <span class="font-serif font-bold text-xl">Rapport Pro</span>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Navigation Links -->
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="navigateTo('editor')" id="nav-editor" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-left bg-brand-600 text-white shadow-lg shadow-brand-900/20">
                <i data-lucide="edit-3" class="w-5 h-5"></i>
                <div class="flex-1">
                    <span class="block font-semibold">Éditeur</span>
                    <span class="block text-xs opacity-80">Rédiger & Mettre en page</span>
                </div>
            </button>
            
            <button onclick="navigateTo('chati')" id="nav-chati" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-left text-slate-400 hover:bg-slate-800 hover:text-white">
                <i data-lucide="sparkles" class="w-5 h-5 text-purple-400"></i>
                <div class="flex-1">
                    <span class="block font-semibold">Chati Chati IA</span>
                    <span class="block text-xs opacity-60">Assistant intelligent</span>
                </div>
            </button>

            <button onclick="navigateTo('history')" id="nav-history" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-left text-slate-400 hover:bg-slate-800 hover:text-white">
                <i data-lucide="history" class="w-5 h-5"></i>
                <div class="flex-1">
                    <span class="block font-semibold">Historique</span>
                    <span class="block text-xs opacity-60">Vos rapports sauvegardés</span>
                </div>
            </button>
        </nav>

        <!-- Sidebar Footer -->
        <div class="p-4 border-t border-slate-800 bg-slate-950/50">
            <div class="text-xs text-slate-500 text-center">
                v2.5 • Mode Local Standalone
            </div>
        </div>
    </aside>

    <!-- === MAIN CONTENT AREA === -->
    <main class="flex-1 flex flex-col relative overflow-hidden w-full bg-slate-50">

        <!-- PAGE: EDITOR -->
        <div id="page-editor" class="flex-1 flex flex-col md:flex-row h-full w-full">
            
            <!-- Mobile Tabs -->
            <div class="md:hidden flex border-b border-slate-200 bg-white z-10 shrink-0">
                <button onclick="switchMobileTab('edit')" id="tab-edit" class="flex-1 py-3 text-sm font-semibold text-center border-b-2 border-brand-600 text-brand-600">
                    <i data-lucide="pen-tool" class="w-4 h-4 inline-block mr-1 mb-0.5"></i> Édition
                </button>
                <button onclick="switchMobileTab('preview')" id="tab-preview" class="flex-1 py-3 text-sm font-semibold text-center border-b-2 border-transparent text-slate-500">
                    <i data-lucide="eye" class="w-4 h-4 inline-block mr-1 mb-0.5"></i> Aperçu
                </button>
            </div>

            <!-- Left Panel: Inputs -->
            <div id="panel-inputs" class="w-full md:w-[450px] lg:w-[500px] flex-shrink-0 bg-white h-full overflow-y-auto border-r border-slate-200 shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-10">
                <div class="p-5 md:p-8 space-y-8 pb-32 md:pb-24">
                    
                    <!-- Report Meta -->
                    <div class="space-y-4">
                        <div class="flex items-center gap-2 text-brand-900 font-bold text-sm uppercase tracking-wider">
                            <i data-lucide="settings-2" class="w-4 h-4"></i> Configuration
                        </div>
                        <div class="space-y-3">
                            <input type="text" id="meta-title" oninput="updateState('title', this.value)" 
                                class="w-full text-xl font-serif font-bold placeholder-slate-300 border-0 border-b-2 border-slate-100 focus:border-brand-500 focus:ring-0 px-0 py-2 transition-colors" 
                                placeholder="Titre du Rapport">
                            
                            <input type="text" id="meta-subject" oninput="updateState('subject', this.value)" 
                                class="w-full text-sm font-medium text-slate-600 placeholder-slate-300 border-0 border-b border-slate-100 focus:border-brand-500 focus:ring-0 px-0 py-2" 
                                placeholder="Ajouter un sous-titre ou sujet...">
                                
                            <div class="flex gap-4">
                                <input type="text" id="meta-author" oninput="updateState('author', this.value)" 
                                    class="flex-1 text-sm text-slate-600 placeholder-slate-300 border-0 border-b border-slate-100 focus:border-brand-500 focus:ring-0 px-0 py-2" 
                                    placeholder="Auteur">
                                <input type="date" id="meta-date" oninput="updateState('date', this.value)" 
                                    class="w-32 text-sm text-slate-600 border-0 border-b border-slate-100 focus:border-brand-500 focus:ring-0 px-0 py-2 bg-transparent">
                            </div>
                        </div>
                    </div>

                    <hr class="border-slate-100">

                    <!-- Sections Builder -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-between sticky top-0 bg-white/95 backdrop-blur py-2 z-10">
                            <div class="text-brand-900 font-bold text-sm uppercase tracking-wider flex items-center gap-2">
                                <i data-lucide="layers" class="w-4 h-4"></i> Sections
                            </div>
                            <div class="flex gap-1 bg-slate-100 p-1 rounded-lg">
                                <button onclick="addSection('heading')" class="p-2 hover:bg-white hover:shadow-sm rounded-md transition-all" title="Ajouter Titre"><i data-lucide="heading" class="w-4 h-4 text-slate-700"></i></button>
                                <button onclick="addSection('paragraph')" class="p-2 hover:bg-white hover:shadow-sm rounded-md transition-all" title="Ajouter Texte"><i data-lucide="align-left" class="w-4 h-4 text-slate-700"></i></button>
                                <button onclick="addSection('image')" class="p-2 hover:bg-white hover:shadow-sm rounded-md transition-all" title="Ajouter Image"><i data-lucide="image" class="w-4 h-4 text-slate-700"></i></button>
                            </div>
                        </div>

                        <div id="sections-list" class="space-y-3 min-h-[200px]">
                            <!-- JS will populate this -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Preview -->
            <div id="panel-preview" class="hidden md:flex flex-1 bg-slate-100/50 h-full overflow-y-auto items-start justify-center p-4 md:p-10 relative">
                <!-- Scale Controls -->
                <div class="fixed md:absolute bottom-4 right-4 md:top-4 md:right-8 md:bottom-auto flex flex-col gap-2 z-20">
                    <div class="bg-white shadow-lg rounded-lg p-1 flex flex-col gap-1 border border-slate-200">
                        <button onclick="exportPDF()" class="p-2 hover:bg-red-50 text-red-600 rounded" title="Export PDF"><i data-lucide="file-down" class="w-5 h-5"></i></button>
                        <button onclick="exportWord()" class="p-2 hover:bg-blue-50 text-blue-600 rounded" title="Export Word"><i data-lucide="file-text" class="w-5 h-5"></i></button>
                    </div>
                </div>

                <!-- The Page -->
                <div id="report-preview-container" class="a4-page transform transition-transform duration-200 origin-top scale-[0.5] sm:scale-[0.6] md:scale-[0.7] lg:scale-[0.8] xl:scale-[0.9] 2xl:scale-100">
                    <!-- JS Content -->
                </div>
            </div>
        </div>

        <!-- PAGE: CHATI (AI) -->
        <div id="page-chati" class="hidden h-full overflow-y-auto bg-slate-50">
            <div class="max-w-3xl mx-auto p-6 md:p-12 space-y-8 pb-32">
                <div class="text-center space-y-3">
                    <div class="w-16 h-16 bg-gradient-to-tr from-brand-600 to-purple-500 rounded-2xl mx-auto flex items-center justify-center shadow-lg shadow-brand-500/30 mb-6">
                        <i data-lucide="sparkles" class="w-8 h-8 text-white"></i>
                    </div>
                    <h2 class="text-3xl md:text-4xl font-serif font-bold text-slate-900">Assistant Intelligent</h2>
                    <p class="text-slate-500 max-w-md mx-auto">Laissez l'IA structurer et rédiger votre rapport. Entrez simplement votre sujet.</p>
                </div>

                <div class="bg-white rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden">
                    <!-- API Key Check -->
                    <div id="ai-setup" class="p-8 text-center space-y-6">
                        <div class="bg-purple-50 text-purple-800 p-4 rounded-xl text-sm inline-block">
                            <i data-lucide="key" class="w-4 h-4 inline mr-2"></i>
                            Clé SambaNova requise (Gratuite)
                        </div>
                        <div class="text-sm text-slate-500">
                            Obtenez votre clé sur <a href="https://cloud.sambanova.ai/" target="_blank" class="text-brand-600 underline font-medium">cloud.sambanova.ai</a>
                        </div>
                        <input type="password" id="api-key-input" class="w-full max-w-sm mx-auto block text-center p-3 border border-slate-200 rounded-xl focus:border-brand-500 focus:ring-2 focus:ring-brand-100 outline-none transition-all" placeholder="Entrez votre clé API...">
                        <button onclick="saveKey()" class="bg-slate-900 text-white px-8 py-3 rounded-xl font-bold hover:bg-slate-800 transition-colors">
                            Activer l'Assistant
                        </button>
                    </div>

                    <!-- AI Form -->
                    <div id="ai-form" class="hidden p-6 md:p-8 space-y-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-slate-700">Sujet du rapport</label>
                            <input type="text" id="ai-topic" class="w-full p-4 bg-slate-50 border-0 rounded-xl focus:ring-2 focus:ring-brand-500 transition-all text-lg" placeholder="Ex: Stratégie Marketing 2025...">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-slate-700">Instructions détaillées (Optionnel)</label>
                            <textarea id="ai-instructions" class="w-full p-4 bg-slate-50 border-0 rounded-xl focus:ring-2 focus:ring-brand-500 transition-all h-32 resize-none" placeholder="Ton formel, insister sur les chiffres, 3 parties..."></textarea>
                        </div>
                        <button onclick="runAI()" id="btn-ai-generate" class="w-full py-4 bg-gradient-to-r from-brand-600 to-purple-600 text-white rounded-xl font-bold text-lg shadow-lg shadow-brand-500/20 hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                            <i data-lucide="wand-2" class="w-5 h-5"></i> Générer le Brouillon
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE: HISTORY -->
        <div id="page-history" class="hidden h-full overflow-y-auto bg-slate-50">
            <div class="max-w-5xl mx-auto p-6 md:p-12 space-y-8 pb-32">
                <div class="flex items-center justify-between">
                    <h2 class="text-3xl font-serif font-bold text-slate-900">Vos Rapports</h2>
                    <button onclick="createNew()" class="bg-brand-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-brand-700 transition-colors flex items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i> Nouveau
                    </button>
                </div>
                
                <div id="history-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cards injected here -->
                </div>
            </div>
        </div>

    </main>

    <!-- === SCRIPTS === -->
    <script>
        // --- APP STATE ---
        const app = {
            report: {
                id: crypto.randomUUID(),
                title: "",
                subject: "",
                author: "",
                date: new Date().toISOString().split('T')[0],
                sections: []
            },
            history: JSON.parse(localStorage.getItem('reports_v2') || '[]'),
            apiKey: localStorage.getItem('sambanova_key') || '',
            view: 'editor', // editor, chati, history
            mobileTab: 'edit' // edit, preview
        };

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadFromHistoryOrNew();
            render();
            
            // Responsive handler
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 768) {
                    document.getElementById('panel-inputs').classList.remove('hidden');
                    document.getElementById('panel-preview').classList.remove('hidden');
                    document.getElementById('sidebar').classList.remove('-translate-x-full');
                } else {
                    applyMobileTab();
                    document.getElementById('sidebar').classList.add('-translate-x-full');
                }
            });
        });

        // --- NAVIGATION ---
        function navigateTo(page) {
            app.view = page;
            // Close sidebar on mobile
            if (window.innerWidth < 768) toggleSidebar(false); // Force close
            render();
        }

        function toggleSidebar(forceState) {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebar-overlay');
            const isClosed = sb.classList.contains('-translate-x-full');
            
            const shouldOpen = forceState !== undefined ? forceState : isClosed;
            
            if (shouldOpen) {
                sb.classList.remove('invisible'); // Make visible before sliding in
                // Small delay to ensure display block is registered before transform
                requestAnimationFrame(() => {
                    sb.classList.remove('-translate-x-full');
                    ov.classList.remove('hidden');
                    ov.classList.remove('opacity-0');
                });
            } else {
                sb.classList.add('-translate-x-full');
                ov.classList.add('opacity-0');
                setTimeout(() => {
                   ov.classList.add('hidden');
                }, 300); // Wait for opacity fade
            }
        }
        
        function handleTransitionEnd(el) {
            if (el.classList.contains('-translate-x-full') && window.innerWidth < 768) {
                el.classList.add('invisible'); // Hide completely after slide out to prevent ghost clicks
            }
        }

        function switchMobileTab(tab) {
            app.mobileTab = tab;
            applyMobileTab();
        }

        function applyMobileTab() {
            const inputs = document.getElementById('panel-inputs');
            const preview = document.getElementById('panel-preview');
            const tEdit = document.getElementById('tab-edit');
            const tPreview = document.getElementById('tab-preview');

            if (window.innerWidth < 768 && app.view === 'editor') {
                if (app.mobileTab === 'edit') {
                    inputs.classList.remove('hidden');
                    preview.classList.add('hidden');
                    tEdit.className = "flex-1 py-3 text-sm font-bold text-center border-b-2 border-brand-600 text-brand-600";
                    tPreview.className = "flex-1 py-3 text-sm font-medium text-center border-b-2 border-transparent text-slate-500";
                } else {
                    inputs.classList.add('hidden');
                    preview.classList.remove('hidden');
                    preview.classList.add('flex'); // ensure flex display
                    tPreview.className = "flex-1 py-3 text-sm font-bold text-center border-b-2 border-brand-600 text-brand-600";
                    tEdit.className = "flex-1 py-3 text-sm font-medium text-center border-b-2 border-transparent text-slate-500";
                }
            }
        }

        // --- CORE LOGIC ---
        function updateState(field, value) {
            app.report[field] = value;
            renderPreview();
        }

        function addSection(type) {
            app.report.sections.push({
                id: crypto.randomUUID(),
                type,
                title: type === 'heading' ? 'Nouvelle Section' : '',
                content: '',
                image: ''
            });
            renderSections();
            renderPreview();
            // Auto switch to edit on mobile
            if (window.innerWidth < 768) switchMobileTab('edit');
        }

        function updateSection(id, key, val) {
            const s = app.report.sections.find(x => x.id === id);
            if (s) {
                s[key] = val;
                renderPreview();
            }
        }

        function deleteSection(id) {
            app.report.sections = app.report.sections.filter(x => x.id !== id);
            renderSections();
            renderPreview();
        }

        function moveSection(idx, dir) {
            const arr = app.report.sections;
            if (idx + dir < 0 || idx + dir >= arr.length) return;
            [arr[idx], arr[idx+dir]] = [arr[idx+dir], arr[idx]];
            renderSections();
            renderPreview();
        }

        function handleImage(file, id) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                updateSection(id, 'image', e.target.result);
                renderSections(); // refresh thumb
            };
            reader.readAsDataURL(file);
        }

        function createNew() {
            app.report = {
                id: crypto.randomUUID(),
                title: "",
                subject: "",
                author: "",
                date: new Date().toISOString().split('T')[0],
                sections: []
            };
            navigateTo('editor');
            // Reset UI inputs
            document.getElementById('meta-title').value = "";
            document.getElementById('meta-subject').value = "";
            document.getElementById('meta-author').value = "";
        }

        function saveReportToHistory() {
            const idx = app.history.findIndex(x => x.id === app.report.id);
            const copy = JSON.parse(JSON.stringify(app.report));
            
            if (!copy.title) copy.title = "Sans Titre"; // Fallback

            if (idx >= 0) app.history[idx] = copy;
            else app.history.push(copy);
            
            localStorage.setItem('reports_v2', JSON.stringify(app.history));
            
            // Visual feedback
            const btn = document.querySelector('button[onclick="saveReportToHistory()"]');
            const original = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="check" class="w-5 h-5 text-green-500"></i>`;
            setTimeout(() => btn.innerHTML = original, 2000);
        }

        function loadFromHistoryOrNew() {
            if (app.history.length > 0) {
                // Load latest? Or just new? Let's default to new but keep history ready
            }
        }

        function loadReport(id) {
            const found = app.history.find(x => x.id === id);
            if (found) {
                app.report = JSON.parse(JSON.stringify(found));
                navigateTo('editor');
            }
        }

        function deleteReport(e, id) {
            e.stopPropagation();
            if(!confirm("Supprimer définitivement ?")) return;
            app.history = app.history.filter(x => x.id !== id);
            localStorage.setItem('reports_v2', JSON.stringify(app.history));
            renderHistory();
        }

        // --- RENDERERS ---
        function render() {
            // Toggle Pages
            ['editor', 'chati', 'history'].forEach(v => {
                const el = document.getElementById(`page-${v}`);
                const nav = document.getElementById(`nav-${v}`);
                
                if (v === app.view) {
                    el.classList.remove('hidden');
                    el.classList.add('flex'); // Ensure flex for layout
                    
                    // Active Nav Style
                    nav.classList.remove('text-slate-400', 'hover:bg-slate-800');
                    nav.classList.add('bg-brand-600', 'text-white', 'shadow-lg');
                    nav.querySelector('span.opacity-60')?.classList.remove('opacity-60');
                    nav.querySelector('span.opacity-80')?.classList.add('opacity-80');
                } else {
                    el.classList.add('hidden');
                    el.classList.remove('flex');
                    
                    // Inactive Nav Style
                    nav.classList.add('text-slate-400', 'hover:bg-slate-800');
                    nav.classList.remove('bg-brand-600', 'text-white', 'shadow-lg');
                }
            });

            if (app.view === 'editor') {
                renderSections();
                renderPreview();
                applyMobileTab();
                
                // Populate Inputs if empty (re-binding)
                const t = document.getElementById('meta-title');
                if (t.value !== app.report.title) t.value = app.report.title;
                document.getElementById('meta-subject').value = app.report.subject || '';
                document.getElementById('meta-author').value = app.report.author || '';
                document.getElementById('meta-date').value = app.report.date || '';
            }
            
            if (app.view === 'chati') renderChati();
            if (app.view === 'history') renderHistory();
            
            lucide.createIcons();
        }

        function renderSections() {
            const list = document.getElementById('sections-list');
            list.innerHTML = '';

            app.report.sections.forEach((s, i) => {
                const item = document.createElement('div');
                item.className = "group bg-white border border-slate-200 rounded-xl p-4 hover:border-brand-300 transition-all hover:shadow-md relative animate-fade-in";
                
                let inner = '';
                
                // Type Icon
                const icon = s.type === 'heading' ? 'heading' : s.type === 'paragraph' ? 'align-left' : 'image';
                
                inner += `
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2 text-xs font-bold text-slate-400 uppercase tracking-wider">
                            <i data-lucide="${icon}" class="w-3 h-3"></i> ${s.type === 'heading' ? 'Titre' : s.type === 'paragraph' ? 'Paragraphe' : 'Image'}
                        </div>
                        <div class="flex gap-1 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="moveSection(${i}, -1)" class="p-1 hover:bg-slate-100 rounded text-slate-500"><i data-lucide="arrow-up" class="w-4 h-4"></i></button>
                            <button onclick="moveSection(${i}, 1)" class="p-1 hover:bg-slate-100 rounded text-slate-500"><i data-lucide="arrow-down" class="w-4 h-4"></i></button>
                            <button onclick="deleteSection('${s.id}')" class="p-1 hover:bg-red-50 rounded text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                `;

                if (s.type === 'heading') {
                    inner += `<input type="text" value="${s.title}" oninput="updateSection('${s.id}', 'title', this.value)" class="w-full font-bold text-lg border-0 border-b border-slate-100 focus:border-brand-500 focus:ring-0 px-0 py-1 placeholder-slate-300" placeholder="Titre de la section...">`;
                } else if (s.type === 'paragraph') {
                    inner += `<textarea oninput="updateSection('${s.id}', 'content', this.value)" class="w-full text-sm leading-relaxed border-0 bg-slate-50 rounded-lg p-3 focus:ring-2 focus:ring-brand-500 resize-y min-h-[100px]" placeholder="Écrivez votre contenu ici...">${s.content || ''}</textarea>`;
                } else if (s.type === 'image') {
                    inner += `
                        <div class="flex gap-3">
                            <div class="w-20 h-20 bg-slate-100 rounded-lg flex items-center justify-center overflow-hidden border border-slate-200 shrink-0">
                                ${s.image ? `<img src="${s.image}" class="w-full h-full object-cover">` : `<i data-lucide="image" class="text-slate-300"></i>`}
                            </div>
                            <div class="flex-1 space-y-2">
                                <label class="block">
                                    <span class="sr-only">Choisir image</span>
                                    <input type="file" accept="image/*" onchange="handleImage(this.files[0], '${s.id}')" class="block w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100"/>
                                </label>
                                <input type="text" value="${s.title || ''}" oninput="updateSection('${s.id}', 'title', this.value)" class="w-full text-xs border border-slate-200 rounded p-1.5" placeholder="Légende (optionnel)">
                            </div>
                        </div>
                    `;
                }

                item.innerHTML = inner;
                list.appendChild(item);
            });
            lucide.createIcons();
        }

        function renderPreview() {
            const container = document.getElementById('report-preview-container');
            const r = app.report;
            
            let html = `
                <div class="text-center mb-12 border-b-2 border-brand-900 pb-8">
                    <h1 class="font-serif text-4xl font-bold text-brand-900 mb-2 leading-tight">${r.title || 'Titre du Rapport'}</h1>
                    ${r.subject ? `<h2 class="text-xl text-slate-500 uppercase tracking-widest font-medium">${r.subject}</h2>` : ''}
                    
                    <div class="flex justify-center gap-6 mt-8 text-sm text-slate-400 font-medium">
                        <span>${r.author || 'Auteur inconnu'}</span>
                        <span>&bull;</span>
                        <span>${new Date(r.date).toLocaleDateString('fr-FR', {year:'numeric', month:'long', day:'numeric'})}</span>
                    </div>
                </div>
            `;

            // Table of Contents (Auto)
            const headings = r.sections.filter(x => x.type === 'heading');
            if (headings.length > 0) {
                html += `
                    <div class="bg-slate-50 p-8 rounded-xl mb-12 break-inside-avoid">
                        <h3 class="font-serif font-bold text-xl text-slate-900 mb-6 pb-2 border-b border-slate-200">Sommaire</h3>
                        <ul class="space-y-3">
                            ${headings.map((h,i) => `
                                <li class="flex items-baseline justify-between text-sm">
                                    <span class="font-medium text-slate-700"><span class="text-brand-500 mr-2">${i+1}.</span>${h.title}</span>
                                    <span class="flex-1 border-b border-dotted border-slate-300 mx-2"></span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            // Content
            html += `<div class="space-y-6 text-slate-800 leading-relaxed">`;
            
            r.sections.forEach(s => {
                if (s.type === 'heading') {
                    html += `<h3 class="font-serif text-2xl font-bold text-brand-800 mt-10 mb-4 pb-2 border-l-4 border-brand-500 pl-4 break-after-avoid">${s.title}</h3>`;
                } else if (s.type === 'paragraph') {
                    html += `<p class="text-justify text-[11pt] text-slate-700 mb-4 whitespace-pre-line">${s.content}</p>`;
                } else if (s.type === 'image' && s.image) {
                    html += `
                        <figure class="my-8 text-center break-inside-avoid">
                            <img src="${s.image}" class="max-h-[400px] max-w-full rounded-lg shadow-sm mx-auto border border-slate-100">
                            ${s.title ? `<figcaption class="mt-2 text-sm text-slate-400 italic">${s.title}</figcaption>` : ''}
                        </figure>
                    `;
                }
            });
            
            html += `</div>`;
            
            // Footer
            html += `
                <div class="mt-20 pt-6 border-t border-slate-100 text-center text-xs text-slate-300">
                    Généré par Rapport Pro • Page 1/1
                </div>
            `;

            container.innerHTML = html;
        }

        function renderChati() {
            const setup = document.getElementById('ai-setup');
            const form = document.getElementById('ai-form');
            
            if (app.apiKey && app.apiKey.length > 5) {
                setup.classList.add('hidden');
                form.classList.remove('hidden');
            } else {
                setup.classList.remove('hidden');
                form.classList.add('hidden');
            }
        }

        function renderHistory() {
            const grid = document.getElementById('history-grid');
            grid.innerHTML = '';
            
            if (app.history.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center py-20 text-slate-400 bg-white rounded-xl border border-dashed border-slate-200">Aucun rapport sauvegardé.</div>`;
                return;
            }

            app.history.forEach(h => {
                const card = document.createElement('div');
                card.className = "bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition-all cursor-pointer group";
                card.onclick = () => loadReport(h.id);
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center">
                            <i data-lucide="file-text" class="w-5 h-5"></i>
                        </div>
                        <button onclick="deleteReport(event, '${h.id}')" class="text-slate-300 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    <h3 class="font-serif font-bold text-lg text-slate-900 mb-1 truncate">${h.title || 'Sans titre'}</h3>
                    <p class="text-sm text-slate-500 mb-4 truncate">${h.subject || '...'}</p>
                    <div class="text-xs text-slate-400 border-t border-slate-50 pt-3 flex justify-between">
                        <span>${h.date}</span>
                        <span class="text-brand-600 opacity-0 group-hover:opacity-100 transition-opacity font-medium">Ouvrir &rarr;</span>
                    </div>
                `;
                grid.appendChild(card);
            });
            lucide.createIcons();
        }

        // --- AI LOGIC ---
        function saveKey() {
            const k = document.getElementById('api-key-input').value.trim();
            if (k.length > 5) {
                app.apiKey = k;
                localStorage.setItem('sambanova_key', k);
                renderChati();
            } else {
                alert("Clé invalide (trop courte)");
            }
        }

        async function runAI() {
            const btn = document.getElementById('btn-ai-generate');
            const topic = document.getElementById('ai-topic').value;
            const instr = document.getElementById('ai-instructions').value;
            
            if (!topic) return;
            
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-5 h-5"></i> Réflexion en cours...`;
            lucide.createIcons();

            try {
                const res = await fetch('https://api.sambanova.ai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${app.apiKey}`
                    },
                    body: JSON.stringify({
                        model: "Meta-Llama-3.1-70B-Instruct",
                        messages: [
                            { role: "system", content: "Tu es un expert en rapports. Réponds UNIQUEMENT un JSON valide: { title, subject, sections: [{type: 'heading'|'paragraph', title?, content?}] }." },
                            { role: "user", content: `Sujet: ${topic}. Instructions: ${instr}` }
                        ],
                        response_format: { type: "json_object" }
                    })
                });
                
                const data = await res.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                const json = JSON.parse(data.choices[0].message.content);
                
                // Apply
                app.report.title = json.title;
                app.report.subject = json.subject;
                app.report.sections = json.sections.map(s => ({
                    ...s,
                    id: crypto.randomUUID(),
                    image: ''
                }));
                
                navigateTo('editor');
                alert("Rapport généré avec succès !");

            } catch (e) {
                alert("Erreur IA: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="wand-2" class="w-5 h-5"></i> Générer le Brouillon`;
                lucide.createIcons();
            }
        }

        // --- EXPORT ---
        function exportPDF() {
            const el = document.getElementById('report-preview-container');
            html2pdf().set({
                margin: 10,
                filename: (app.report.title || 'rapport') + '.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).from(el).save();
        }

        function exportWord() {
            const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType } = docx;
            
            const doc = new Document({
                sections: [{
                    properties: {},
                    children: [
                        new Paragraph({ text: app.report.title || "Rapport", heading: HeadingLevel.TITLE, alignment: AlignmentType.CENTER }),
                        new Paragraph({ text: app.report.subject || "", heading: HeadingLevel.HEADING_2, alignment: AlignmentType.CENTER }),
                        
                        ...app.report.sections.flatMap(s => {
                            if (s.type === 'heading') return new Paragraph({ text: s.title, heading: HeadingLevel.HEADING_1, spacing: {before: 400, after: 200} });
                            if (s.type === 'paragraph') return new Paragraph({ text: s.content, spacing: {after: 200}, alignment: AlignmentType.JUSTIFIED });
                            if (s.type === 'image') return new Paragraph({ text: "[Image non incluse dans cette version Word]", alignment: AlignmentType.CENTER, italics: true });
                            return [];
                        })
                    ]
                }]
            });
            
            Packer.toBlob(doc).then(blob => {
                saveAs(blob, (app.report.title || 'rapport') + '.docx');
            });
        }

    </script>
</body>
</html>