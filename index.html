<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur de Rapports Pro</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- docx.js -->
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <!-- FileSaver.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Marked for Markdown parsing (optional but good for AI text) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        h1, h2, h3, h4, h5, h6, .font-serif {
            font-family: 'Playfair Display', serif;
        }
        
        /* A4 Paper Simulation */
        .a4-page {
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #report-preview-container, #report-preview-container * {
                visibility: visible;
            }
            #report-preview-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
            }
            .a4-page {
                box-shadow: none;
                margin: 0;
                width: 100%;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }

        .hidden-section {
            display: none;
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af', // blue-800
                        secondary: '#f1f5f9', // slate-100
                    }
                }
            }
        }
    </script>
</head>
<body class="h-screen flex overflow-hidden text-slate-800">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-slate-900 text-white h-full flex flex-col flex-shrink-0 shadow-xl z-10">
        <div class="p-6 border-b border-slate-800">
            <h1 class="text-xl font-serif font-bold flex items-center gap-2">
                <i data-lucide="file-text" class="text-blue-400"></i> Rapport Pro
            </h1>
        </div>
        
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="showPage('editor')" id="nav-editor" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-left bg-blue-700 text-white">
                <i data-lucide="edit-3" size="20"></i>
                <span class="font-medium">√âditeur</span>
            </button>
            <button onclick="showPage('chati')" id="nav-chati" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-left text-slate-400 hover:bg-slate-800 hover:text-white">
                <i data-lucide="message-square" size="20"></i>
                <span class="font-medium">Chati Chati (IA)</span>
            </button>
            <button onclick="showPage('history')" id="nav-history" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-left text-slate-400 hover:bg-slate-800 hover:text-white">
                <i data-lucide="history" size="20"></i>
                <span class="font-medium">Historique</span>
            </button>
        </nav>

        <div class="p-4 border-t border-slate-800 text-xs text-slate-500 text-center">
            Version Standalone ‚Ä¢ Local
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex h-full overflow-hidden relative">
        
        <!-- PAGE: EDITOR -->
        <div id="page-editor" class="flex-1 flex w-full h-full">
            <!-- Editor Inputs (Left) -->
            <div class="w-full md:w-1/2 h-full overflow-y-auto p-6 bg-slate-50 border-r border-slate-200">
                <div class="max-w-2xl mx-auto space-y-8 pb-20">
                    
                    <!-- Metadata -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 space-y-4">
                        <h2 class="text-lg font-bold text-blue-900 flex items-center gap-2">
                            <i data-lucide="info"></i> Informations
                        </h2>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Titre du Rapport</label>
                                <input type="text" id="input-title" oninput="updateReport('title', this.value)" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-serif font-bold" placeholder="Titre...">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Sujet / Sous-titre</label>
                                    <input type="text" id="input-subject" oninput="updateReport('subject', this.value)" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Sujet...">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Auteur</label>
                                    <input type="text" id="input-author" oninput="updateReport('author', this.value)" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nom...">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sections List -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-bold text-slate-700">Contenu</h3>
                            <div class="flex gap-2">
                                <button onclick="addSection('heading')" class="px-3 py-1.5 bg-white border border-slate-300 rounded hover:bg-slate-50 text-sm font-medium flex items-center gap-1">
                                    <i data-lucide="heading" class="w-4 h-4"></i> Titre
                                </button>
                                <button onclick="addSection('paragraph')" class="px-3 py-1.5 bg-white border border-slate-300 rounded hover:bg-slate-50 text-sm font-medium flex items-center gap-1">
                                    <i data-lucide="align-left" class="w-4 h-4"></i> Texte
                                </button>
                                <button onclick="addSection('image')" class="px-3 py-1.5 bg-white border border-slate-300 rounded hover:bg-slate-50 text-sm font-medium flex items-center gap-1">
                                    <i data-lucide="image" class="w-4 h-4"></i> Image
                                </button>
                            </div>
                        </div>

                        <div id="sections-container" class="space-y-4">
                            <!-- Sections will be injected here by JS -->
                            <div class="text-center py-10 border-2 border-dashed border-slate-300 rounded-lg text-slate-400">
                                Aucun contenu. Ajoutez une section ou utilisez Chati Chati.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Floating Actions Bar -->
                <div class="fixed bottom-6 left-6 md:left-[calc(256px+24px)] right-6 md:right-[calc(50%+24px)] bg-white/90 backdrop-blur p-4 rounded-xl shadow-lg border border-slate-200 flex justify-between items-center z-20">
                    <button onclick="saveReportToHistory()" class="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 shadow-lg transition-transform active:scale-95">
                        <i data-lucide="save" class="w-4 h-4"></i> Sauvegarder
                    </button>
                    <div class="flex gap-2">
                        <button onclick="generatePDF()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 shadow-lg transition-transform active:scale-95">
                            <i data-lucide="file-down" class="w-4 h-4"></i> PDF
                        </button>
                        <button onclick="generateWord()" class="bg-blue-700 hover:bg-blue-800 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 shadow-lg transition-transform active:scale-95">
                            <i data-lucide="file-text" class="w-4 h-4"></i> Word
                        </button>
                    </div>
                </div>
            </div>

            <!-- Preview (Right) -->
            <div class="hidden md:flex w-1/2 h-full bg-slate-200 p-8 overflow-y-auto justify-center items-start">
                <div id="report-preview-container" class="a4-page text-slate-900 transform origin-top scale-[0.85] xl:scale-100 transition-transform">
                    <!-- Preview content injected here -->
                </div>
            </div>
        </div>

        <!-- PAGE: CHATI CHATI -->
        <div id="page-chati" class="hidden-section w-full h-full overflow-y-auto bg-slate-50 p-6 md:p-12">
            <div class="max-w-3xl mx-auto space-y-8">
                <div class="text-center space-y-4">
                    <h1 class="text-4xl font-serif font-bold text-blue-900">Chati Chati ü§ñ</h1>
                    <p class="text-lg text-slate-600">
                        Votre assistant IA pour r√©diger des rapports professionnels en quelques secondes.
                    </p>
                </div>

                <!-- API Key Section -->
                <div id="api-key-section" class="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="key" class="text-yellow-500"></i> Configuration Cl√© OpenAI
                    </h3>
                    <div class="flex gap-4">
                        <input type="password" id="openai-key" class="flex-1 p-3 border border-slate-300 rounded-lg" placeholder="sk-...">
                        <button onclick="saveApiKey()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700">
                            Enregistrer
                        </button>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">Votre cl√© est stock√©e localement dans votre navigateur. Elle n'est jamais partag√©e.</p>
                </div>

                <!-- Chat Interface -->
                <div id="chat-interface" class="hidden bg-white p-6 rounded-xl shadow-lg border border-blue-100 space-y-6">
                    <div class="space-y-2">
                        <label class="font-bold text-slate-700">Sujet du Rapport</label>
                        <input type="text" id="ai-topic" class="w-full p-4 text-lg border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ex: L'impact de l'IA sur l'emploi...">
                    </div>
                    
                    <div class="space-y-2">
                        <label class="font-bold text-slate-700">Instructions Sp√©cifiques</label>
                        <textarea id="ai-instructions" class="w-full p-4 h-32 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ex: Fais un plan en 3 parties, inclus une conclusion optimiste..."></textarea>
                    </div>

                    <button onclick="generateWithAI()" id="btn-generate" class="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-bold text-lg shadow-lg hover:scale-[1.01] transition-transform flex justify-center items-center gap-2">
                        <i data-lucide="wand-2"></i> G√©n√©rer le Rapport
                    </button>
                </div>
            </div>
        </div>

        <!-- PAGE: HISTORY -->
        <div id="page-history" class="hidden-section w-full h-full overflow-y-auto bg-slate-50 p-6 md:p-12">
            <div class="max-w-5xl mx-auto space-y-8">
                <h1 class="text-3xl font-serif font-bold text-blue-900">Historique des Rapports</h1>
                
                <div id="history-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- History items injected here -->
                </div>
            </div>
        </div>

    </main>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- STATE MANAGEMENT ---
        const state = {
            report: {
                id: crypto.randomUUID(),
                title: "Nouveau Rapport",
                subject: "",
                author: "",
                date: new Date().toISOString(),
                sections: []
            },
            apiKey: localStorage.getItem('openai_api_key') || '',
            history: JSON.parse(localStorage.getItem('saved_reports') || '[]')
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            renderEditor();
            renderPreview();
            checkApiKey();
            renderHistory();
        });

        // --- NAVIGATION ---
        function showPage(pageId) {
            // Hide all pages
            ['editor', 'chati', 'history'].forEach(p => {
                document.getElementById(`page-${p}`).classList.add('hidden-section');
                document.getElementById(`nav-${p}`).classList.remove('bg-blue-700', 'text-white');
                document.getElementById(`nav-${p}`).classList.add('text-slate-400');
            });

            // Show selected
            document.getElementById(`page-${pageId}`).classList.remove('hidden-section');
            // Update Nav
            const navBtn = document.getElementById(`nav-${pageId}`);
            navBtn.classList.remove('text-slate-400', 'hover:bg-slate-800');
            navBtn.classList.add('bg-blue-700', 'text-white');

            // Specific page logic
            if (pageId === 'page-history') renderHistory();
        }

        // --- EDITOR LOGIC ---
        function updateReport(field, value) {
            state.report[field] = value;
            renderPreview();
        }

        function addSection(type) {
            state.report.sections.push({
                id: crypto.randomUUID(),
                type: type,
                title: type === 'heading' ? 'Nouvelle Section' : '',
                content: type === 'paragraph' ? '' : '',
                imageUrl: '',
                imageCaption: ''
            });
            renderEditor();
            renderPreview();
        }

        function updateSection(id, field, value) {
            const section = state.report.sections.find(s => s.id === id);
            if (section) {
                section[field] = value;
                renderPreview(); // Real-time preview
            }
        }

        function removeSection(id) {
            state.report.sections = state.report.sections.filter(s => s.id !== id);
            renderEditor();
            renderPreview();
        }

        function moveSection(index, direction) {
            const newSections = [...state.report.sections];
            if (index + direction < 0 || index + direction >= newSections.length) return;
            [newSections[index], newSections[index + direction]] = [newSections[index + direction], newSections[index]];
            state.report.sections = newSections;
            renderEditor();
            renderPreview();
        }

        function handleImageUpload(file, sectionId) {
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    updateSection(sectionId, 'imageUrl', reader.result);
                    // Also update the preview for the input thumbnail
                    const imgPreview = document.getElementById(`img-preview-${sectionId}`);
                    if(imgPreview) imgPreview.src = reader.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // --- RENDERING ---
        function renderEditor() {
            // Inputs
            document.getElementById('input-title').value = state.report.title;
            document.getElementById('input-subject').value = state.report.subject || '';
            document.getElementById('input-author').value = state.report.author || '';

            // Sections
            const container = document.getElementById('sections-container');
            container.innerHTML = '';

            if (state.report.sections.length === 0) {
                container.innerHTML = `<div class="text-center py-10 border-2 border-dashed border-slate-300 rounded-lg text-slate-400">Aucun contenu.</div>`;
                return;
            }

            state.report.sections.forEach((section, index) => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-lg border border-slate-200 shadow-sm relative group hover:border-blue-400 transition-colors";
                
                let contentHtml = '';
                
                // Controls
                const controls = `
                    <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="moveSection(${index}, -1)" class="p-1 hover:bg-slate-100 rounded text-slate-600"><i data-lucide="arrow-up" class="w-4 h-4"></i></button>
                        <button onclick="moveSection(${index}, 1)" class="p-1 hover:bg-slate-100 rounded text-slate-600"><i data-lucide="arrow-down" class="w-4 h-4"></i></button>
                        <button onclick="removeSection('${section.id}')" class="p-1 hover:bg-red-100 rounded text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                `;

                if (section.type === 'heading') {
                    contentHtml = `
                        <label class="block text-xs font-bold text-blue-600 uppercase mb-1">Titre de section</label>
                        <input type="text" value="${section.title}" oninput="updateSection('${section.id}', 'title', this.value)" class="w-full p-2 font-bold text-lg border-b border-slate-200 focus:border-blue-500 outline-none">
                    `;
                } else if (section.type === 'paragraph') {
                    contentHtml = `
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Paragraphe</label>
                        <textarea oninput="updateSection('${section.id}', 'content', this.value)" class="w-full p-2 min-h-[100px] border border-slate-200 rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm leading-relaxed">${section.content || ''}</textarea>
                    `;
                } else if (section.type === 'image') {
                    contentHtml = `
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Image</label>
                        <div class="flex gap-4 items-start">
                            <div class="w-24 h-24 bg-slate-100 rounded border flex items-center justify-center overflow-hidden flex-shrink-0">
                                ${section.imageUrl ? `<img id="img-preview-${section.id}" src="${section.imageUrl}" class="w-full h-full object-cover">` : `<i data-lucide="image" class="text-slate-300"></i>`}
                            </div>
                            <div class="flex-1 space-y-2">
                                <input type="file" accept="image/*" onchange="handleImageUpload(this.files[0], '${section.id}')" class="text-sm block w-full text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                <input type="text" value="${section.imageCaption || ''}" oninput="updateSection('${section.id}', 'imageCaption', this.value)" placeholder="L√©gende..." class="w-full p-2 text-sm border border-slate-200 rounded">
                            </div>
                        </div>
                    `;
                }

                div.innerHTML = controls + contentHtml;
                container.appendChild(div);
            });
            
            // Re-init icons for new elements
            lucide.createIcons();
        }

        function renderPreview() {
            const container = document.getElementById('report-preview-container');
            const r = state.report;
            const dateFormatted = new Date(r.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });

            // Generate Table of Contents
            const headings = r.sections.filter(s => s.type === 'heading');
            let tocHtml = '';
            if (headings.length > 0) {
                tocHtml = `
                    <div class="mb-12 bg-slate-50 p-6 rounded-lg border border-slate-200 break-inside-avoid">
                        <h3 class="text-xl font-serif font-bold text-blue-900 mb-4 border-b border-slate-300 pb-2">Sommaire</h3>
                        <ul class="space-y-2">
                            ${headings.map((h, i) => `
                                <li class="flex justify-between text-sm">
                                    <span class="font-medium text-slate-700">${i+1}. ${h.title}</span>
                                    <span class="border-b border-dotted border-slate-300 flex-1 mx-2 relative top-[-4px]"></span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            // Generate Sections
            const sectionsHtml = r.sections.map((s, i) => {
                if (s.type === 'heading') {
                    return `<h2 class="text-2xl font-serif font-bold text-blue-900 mt-8 mb-4 border-l-4 border-blue-600 pl-4 break-after-avoid">${s.title}</h2>`;
                } else if (s.type === 'paragraph') {
                    return `<p class="text-justify leading-relaxed text-slate-800 whitespace-pre-line mb-4">${s.content || ''}</p>`;
                } else if (s.type === 'image' && s.imageUrl) {
                    return `
                        <figure class="my-8 flex flex-col items-center break-inside-avoid">
                            <img src="${s.imageUrl}" class="max-w-full max-h-[400px] rounded shadow-md border border-slate-200">
                            ${s.imageCaption ? `<figcaption class="mt-3 text-sm font-medium text-slate-500 italic">Figure: ${s.imageCaption}</figcaption>` : ''}
                        </figure>
                    `;
                }
                return '';
            }).join('');

            container.innerHTML = `
                <header class="text-center border-b-4 border-blue-900 pb-8 mb-12">
                    <h1 class="text-4xl font-serif font-bold text-blue-900 mb-4">${r.title}</h1>
                    ${r.subject ? `<h2 class="text-xl text-slate-600 font-medium mb-4 uppercase tracking-wider">${r.subject}</h2>` : ''}
                    <div class="flex justify-center items-center gap-4 text-sm text-slate-500 mt-8">
                        <span>${r.author || 'Auteur'}</span> ‚Ä¢ <span>${dateFormatted}</span>
                    </div>
                </header>
                ${tocHtml}
                <div class="content">
                    ${sectionsHtml}
                </div>
                <footer class="mt-20 pt-8 border-t border-slate-200 text-center text-xs text-slate-400">
                    G√©n√©r√© par Rapport Pro ‚Ä¢ ${new Date().getFullYear()}
                </footer>
            `;
        }

        // --- CHATI CHATI (AI) ---
        function checkApiKey() {
            if (state.apiKey && state.apiKey.startsWith('sk-')) {
                document.getElementById('api-key-section').classList.add('hidden');
                document.getElementById('chat-interface').classList.remove('hidden');
            } else {
                document.getElementById('api-key-section').classList.remove('hidden');
                document.getElementById('chat-interface').classList.add('hidden');
            }
        }

        function saveApiKey() {
            const key = document.getElementById('openai-key').value.trim();
            if (key.startsWith('sk-')) {
                state.apiKey = key;
                localStorage.setItem('openai_api_key', key);
                checkApiKey();
                alert("Cl√© enregistr√©e !");
            } else {
                alert("Cl√© invalide. Elle doit commencer par 'sk-'.");
            }
        }

        async function generateWithAI() {
            const topic = document.getElementById('ai-topic').value;
            const instructions = document.getElementById('ai-instructions').value;
            const btn = document.getElementById('btn-generate');

            if (!topic) return alert("Veuillez entrer un sujet.");

            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin"></i> G√©n√©ration...`;
            lucide.createIcons();

            try {
                const systemPrompt = `
                    Tu es un expert en r√©daction de rapports professionnels.
                    G√©n√®re une structure JSON valide pour un rapport sur le sujet donn√©.
                    Format attendu:
                    {
                        "title": "Titre",
                        "subject": "Sous-titre",
                        "sections": [
                            {"type": "heading", "title": "Titre section"},
                            {"type": "paragraph", "content": "Contenu d√©taill√© (min 3 phrases)."}
                        ]
                    }
                    R√®gles: Ton pro, structure claire (Intro, Dev, Conclusion). Pas d'images.
                `;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o", // Fallback to gpt-3.5-turbo if needed
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: `Sujet: ${topic}\nInstructions: ${instructions}` }
                        ],
                        response_format: { type: "json_object" }
                    })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                const content = JSON.parse(data.choices[0].message.content);
                
                // Update State
                state.report.title = content.title;
                state.report.subject = content.subject;
                state.report.sections = content.sections.map(s => ({
                    ...s,
                    id: crypto.randomUUID(),
                    imageUrl: '',
                    imageCaption: ''
                }));

                // Reset UI
                renderEditor();
                renderPreview();
                showPage('editor');
                alert("Rapport g√©n√©r√© ! V√©rifiez et ajustez le contenu.");

            } catch (error) {
                console.error(error);
                alert("Erreur lors de la g√©n√©ration: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="wand-2"></i> G√©n√©rer le Rapport`;
                lucide.createIcons();
            }
        }

        // --- HISTORY & STORAGE ---
        function saveReportToHistory() {
            const existingIndex = state.history.findIndex(r => r.id === state.report.id);
            if (existingIndex >= 0) {
                state.history[existingIndex] = JSON.parse(JSON.stringify(state.report));
            } else {
                state.history.push(JSON.parse(JSON.stringify(state.report)));
            }
            localStorage.setItem('saved_reports', JSON.stringify(state.history));
            alert("Rapport sauvegard√© dans l'historique.");
            renderHistory();
        }

        function renderHistory() {
            const container = document.getElementById('history-list');
            if (state.history.length === 0) {
                container.innerHTML = `<div class="col-span-3 text-center text-slate-400">Aucun historique.</div>`;
                return;
            }

            container.innerHTML = state.history.map(r => `
                <div class="bg-white p-6 rounded-xl border border-slate-200 hover:shadow-md cursor-pointer transition-all" onclick="loadReport('${r.id}')">
                    <h3 class="font-serif font-bold text-lg text-blue-900 mb-1">${r.title}</h3>
                    <p class="text-sm text-slate-500 mb-4">${r.subject || 'Sans sujet'}</p>
                    <div class="flex justify-between items-center text-xs text-slate-400 border-t pt-3">
                        <span>${new Date(r.date).toLocaleDateString()}</span>
                        <button onclick="deleteReport(event, '${r.id}')" class="text-red-500 hover:text-red-700 font-bold">Supprimer</button>
                    </div>
                </div>
            `).join('');
        }

        function loadReport(id) {
            const found = state.history.find(r => r.id === id);
            if (found) {
                state.report = JSON.parse(JSON.stringify(found)); // Deep copy
                renderEditor();
                renderPreview();
                showPage('editor');
            }
        }

        function deleteReport(e, id) {
            e.stopPropagation();
            if (confirm("Supprimer ce rapport ?")) {
                state.history = state.history.filter(r => r.id !== id);
                localStorage.setItem('saved_reports', JSON.stringify(state.history));
                renderHistory();
                // If deleted current report, reset
                if (state.report.id === id) {
                    state.report = {
                        id: crypto.randomUUID(),
                        title: "Nouveau Rapport",
                        sections: [],
                        date: new Date().toISOString()
                    };
                    renderEditor();
                    renderPreview();
                }
            }
        }

        // --- EXPORT FUNCTIONS ---
        function generatePDF() {
            const element = document.getElementById('report-preview-container');
            const opt = {
                margin: 10,
                filename: `${state.report.title.replace(/\s+/g, '_')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function generateWord() {
            // Using docx global
            const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType } = docx;
            
            const doc = new Document({
                sections: [{
                    properties: {},
                    children: [
                        // Title
                        new Paragraph({
                            text: state.report.title,
                            heading: HeadingLevel.TITLE,
                            alignment: AlignmentType.CENTER,
                            spacing: { after: 300 },
                        }),
                        // Subject
                        new Paragraph({
                            text: state.report.subject || "",
                            heading: HeadingLevel.HEADING_2,
                            alignment: AlignmentType.CENTER,
                            spacing: { after: 200 },
                        }),
                        // Meta
                        new Paragraph({
                            children: [
                                new TextRun({ text: `Auteur: ${state.report.author || ''}`, bold: true }),
                                new TextRun({ text: `\nDate: ${new Date(state.report.date).toLocaleDateString()}`, break: 1 }),
                            ],
                            alignment: AlignmentType.CENTER,
                            spacing: { after: 500 },
                        }),
                        
                        // Sections
                        ...state.report.sections.flatMap(s => {
                            const els = [];
                            if (s.type === 'heading') {
                                els.push(new Paragraph({
                                    text: s.title,
                                    heading: HeadingLevel.HEADING_1,
                                    spacing: { before: 400, after: 200 },
                                }));
                            } else if (s.type === 'paragraph') {
                                els.push(new Paragraph({
                                    text: s.content,
                                    spacing: { after: 200 },
                                    alignment: AlignmentType.JUSTIFIED
                                }));
                            } else if (s.type === 'image') {
                                els.push(new Paragraph({
                                    children: [new TextRun({text: "[Image: Voir PDF pour le rendu visuel]", italics: true})],
                                    alignment: AlignmentType.CENTER,
                                    spacing: { after: 100 }
                                }));
                                if (s.imageCaption) {
                                    els.push(new Paragraph({
                                        text: `Figure: ${s.imageCaption}`,
                                        alignment: AlignmentType.CENTER,
                                        style: "Caption"
                                    }));
                                }
                            }
                            return els;
                        })
                    ]
                }]
            });

            Packer.toBlob(doc).then(blob => {
                saveAs(blob, `${state.report.title.replace(/\s+/g, '_')}.docx`);
            });
        }

    </script>
</body>
</html>
